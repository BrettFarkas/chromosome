<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karyogram Virtual Lab (46,XY)</title>
  <style>
    :root{
      --bg:#f5f7fb;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;
      --brand:#4f46e5;--brand-2:#e0e7ff;--ok:#16a34a;--warn:#f59e0b;--err:#e11d48;--teal:#06b6d4;
    }
    *{box-sizing:border-box}
    html,body{height:100dvh;overflow:hidden}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--ink);background:var(--bg)}

    /* Fit-to-screen layout */
    #stage{position:relative;width:100%;height:100dvh;overflow:hidden}
    #app{transform-origin:top left}

    .container{max-width:1100px;margin:0 auto;padding:16px}
    .header{background:var(--brand);color:#fff;padding:12px 16px;border-radius:16px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#fff;color:var(--ink);padding:6px 10px;border-radius:9999px;margin-left:8px}
    .badge .label{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}

    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;text-align:center;box-shadow:0 1px 2px rgb(0 0 0 / .04)}
    #score{font-size:48px;font-weight:800;line-height:1;display:inline-block}
    #score.pop{animation:pop 450ms ease}
    @keyframes pop{0%{transform:scale(1)}35%{transform:scale(1.25)}100%{transform:scale(1)}}

    .tray{display:flex;align-items:center;gap:12px;background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px}
    .chrom-card{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--line);background:#fff;padding:8px 10px;border-radius:14px;box-shadow:0 1px 2px rgb(0 0 0 / .06);cursor:grab}
    .chrom-card[aria-selected="true"]{outline:4px solid var(--brand-2)}
    .chrom-label{font-weight:700;font-size:18px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .feedback{min-height:24px;margin:8px 0;font-weight:700;text-align:center}

    .karyogram{background:var(--card);border:1px solid var(--line);border-radius:24px;padding:18px;box-shadow:0 2px 4px rgb(0 0 0 / .04)}
    .kgrid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-top:12px}
    .pair{border:1px solid var(--line);background:#fff;border-radius:16px;padding:8px}
    .pair .title{font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px}
    .slots{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}

    .slot{min-height:110px;display:flex;align-items:flex-end;justify-content:center;border:2px dashed #cbd5e1;border-radius:12px;background:linear-gradient(#fff,#f8fafc);position:relative;outline:0;padding:6px}
    .slot .cap{position:absolute;left:8px;top:6px;font-size:10px;color:#94a3b8}
    .slot.accept{box-shadow:0 0 0 4px var(--brand-2)}
    .slot.hint{animation:pulse 1.2s infinite;box-shadow:0 0 0 4px rgba(245,158,11,.35)}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245,158,11,.45)}70%{box-shadow:0 0 0 10px rgba(245,158,11,0)}100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}}

    /* visual distinction */
    .slot.static{border-style:solid;background:#f3f4f6;border-color:#e5e7eb}
    .slot.filled{border-style:solid;background:linear-gradient(#ecfeff,#cffafe);border-color:var(--teal);box-shadow:inset 0 0 0 2px rgba(6,182,212,.35),0 0 18px rgba(6,182,212,.25)}
    .slot.just-placed{animation:glow 800ms ease both}
    @keyframes glow{0%{transform:scale(1);box-shadow:0 0 0 0 rgba(6,182,212,0)}50%{transform:scale(1.04);box-shadow:0 0 0 10px rgba(6,182,212,.35)}100%{transform:scale(1);box-shadow:0 0 0 0 rgba(6,182,212,0)}}

    /* overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:24px}
    .overlay[aria-hidden="false"]{display:flex}
    .modal{max-width:480px;width:100%;background:#fff;border-radius:24px;border:1px solid var(--line);padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.15)}

    /* confetti */
    .confetti{position:fixed;top:-10px;width:8px;height:12px;opacity:.95;pointer-events:none;z-index:9999;animation:confetti-fall 1100ms linear forwards}
    @keyframes confetti-fall{0%{transform:translateY(-10px) rotate(0)}100%{transform:translateY(110vh) rotate(360deg)}}

    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
<div id="stage">
  <div id="app" class="container">
    <div class="header">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div>
          <div style="font-size:20px;font-weight:800">Virtual Lab: Build the Karyogram</div>
          <div style="opacity:.9">Drag the presented chromosome onto its matching slot.</div>
        </div>
        <div class="badge" aria-label="Karyotype 46,XY">
          <span class="label">Karyotype</span>
          <strong>46,XY</strong>
          <span class="muted" style="font-size:12px">(Human male)</span>
        </div>
      </div>
    </div>

    <div class="stats">
      <div class="card"><span id="score">0</span><div>Placed</div></div>
      <div class="card"><span id="attempts">0</span><div>Attempts</div></div>
      <div class="card"><span id="accuracy">100%</span><div>Accuracy</div></div>
    </div>

    <div class="tray" role="region" aria-label="Presented chromosome tray">
      <div class="muted">Presented chromosome</div>
      <div id="tray"></div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" id="btn-hint">Hint</button>
        <button class="btn" id="btn-reset">Reset</button>
      </div>
    </div>

    <div id="feedback" class="feedback" aria-live="polite"></div>

    <section class="karyogram" aria-label="Karyogram grid">
      <div id="kgrid" class="kgrid"></div>
    </section>
  </div>
</div>

<!-- Completion overlay -->
<div id="overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Completion dialog">
  <div class="modal">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:22px;height:22px;border-radius:999px;background:#bbf7d0;display:grid;place-items:center">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
          <path d="M9 12l2 2 4-4" stroke="#16a34a" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
      <h2 style="margin:0">Karyogram Complete!</h2>
    </div>
    <p class="muted">Great job. You assembled a <strong>46,XY</strong> karyotype.</p>
    <div class="stats" style="margin-top:12px">
      <div class="card"><div class="label">Placed</div><div id="done-placed" class="value" style="font-size:24px;font-weight:700">0</div></div>
      <div class="card"><div class="label">Attempts</div><div id="done-attempts" class="value" style="font-size:24px;font-weight:700">0</div></div>
      <div class="card"><div class="label">Accuracy</div><div id="done-accuracy" class="value" style="font-size:24px;font-weight:700">100%</div></div>
    </div>
    <div style="text-align:right"><button class="btn" id="btn-again">Do it again</button></div>
  </div>
</div>

<div class="sr" id="live-region" aria-live="polite"></div>

<script>
(function(){
  'use strict';

  // --- Helpers and Tests ---------------------------------------------------
  const AUTOSOMES = Array.from({length:22}, (_,i)=>String(i+1));
  const SHUFFLE = (a)=>{ const x=[...a]; for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x; };
  function getAccuracy(score, attempts){ return attempts>0? Math.round((score/attempts)*100) : 100; }
  function isCorrectDrop(slotChrom, currentChrom){ return currentChrom!=null && slotChrom===currentChrom; }
  // sanity tests (open console to verify)
  console.assert(getAccuracy(5,10)===50, 'accuracy 5/10=50');
  console.assert(getAccuracy(0,0)===100, 'accuracy default 100');
  console.assert(isCorrectDrop('7','7')===true, 'correct drop true');
  console.assert(isCorrectDrop('7','8')===false, 'correct drop false');

  // --- Fit to screen -------------------------------------------------------
  const stage = document.getElementById('stage');
  const appEl = document.getElementById('app');
  function fitToScreen(){
    const naturalWidth = appEl.scrollWidth; const naturalHeight = appEl.scrollHeight;
    const sw = stage.clientWidth; const sh = stage.clientHeight;
    const s = Math.min(1, sw/naturalWidth, sh/naturalHeight);
    appEl.style.transform = 'scale(' + s + ')';
  }
  window.addEventListener('resize', fitToScreen);

  // --- State ---------------------------------------------------------------
  let placed = {}; // label -> boolean (only the target slot per chrom)
  let currentChrom = null; // label currently presented
  let attempts = 0; let score = 0; let lastScore = 0;
  let isPicking = false; let hintFor = null;

  // --- Build grid ----------------------------------------------------------
  const kgrid = document.getElementById('kgrid');
  function buildGrid(){
    kgrid.innerHTML = '';
    const order = [
      '1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','SEX'
    ];
    order.forEach((key)=>{
      if(key==='SEX') kgrid.appendChild(buildSexCell());
      else kgrid.appendChild(buildPairCell(key));
    });
  }

  function buildPairCell(chrom){
    const wrap = document.createElement('div'); wrap.className='pair';
    const title = document.createElement('div'); title.className='title'; title.textContent = 'Chromosome '+chrom; wrap.appendChild(title);
    const slots = document.createElement('div'); slots.className='slots';

    const left = document.createElement('div'); left.className='slot'; left.dataset.chrom=chrom; left.dataset.side='left';
    const right = document.createElement('div'); right.className='slot'; right.dataset.chrom=chrom; right.dataset.side='right';
    left.appendChild(sideCap('left')); right.appendChild(sideCap('right'));

    const staticLeft = Math.random()>0.5;
    const staticSlot = staticLeft? left : right;
    const targetSlot = staticLeft? right : left;

    staticSlot.classList.add('static');
    staticSlot.appendChild(makeChromosomeEl(chrom,false));

    targetSlot.id = 'slot-'+chrom; targetSlot.dataset.state='empty';
    targetSlot.appendChild(makeChromosomeEl(chrom,true));

    bindSlotEvents(targetSlot, chrom);

    slots.appendChild(left); slots.appendChild(right); wrap.appendChild(slots); return wrap;
  }

  function buildSexCell(){
    const wrap = document.createElement('div'); wrap.className='pair';
    const title = document.createElement('div'); title.className='title'; title.textContent='Sex Chromosomes'; wrap.appendChild(title);
    const slots = document.createElement('div'); slots.className='slots';

    const left = document.createElement('div'); left.className='slot'; left.dataset.chrom='X'; left.dataset.side='left'; left.appendChild(sideCap('X'));
    const right = document.createElement('div'); right.className='slot'; right.dataset.chrom='Y'; right.dataset.side='right'; right.appendChild(sideCap('Y'));

    const staticIsX = Math.random()>0.5; const staticSlot = staticIsX? left:right; const targetSlot = staticIsX? right:left; const targetLabel = staticIsX? 'Y':'X';

    staticSlot.classList.add('static');
    staticSlot.appendChild(makeChromosomeEl(staticIsX? 'X':'Y', false));

    targetSlot.id = 'slot-'+targetLabel; targetSlot.dataset.state='empty';
    targetSlot.appendChild(makeChromosomeEl(targetLabel, true));

    bindSlotEvents(targetSlot, targetLabel);

    slots.appendChild(left); slots.appendChild(right); wrap.appendChild(slots); return wrap;
  }

  function sideCap(text){ const d=document.createElement('div'); d.className='cap'; d.textContent=text; return d; }

  // --- Chromosome SVG ------------------------------------------------------
  const lengthMap = {1:120,2:115,3:110,4:105,5:100,6:96,7:92,8:88,9:84,10:80,11:76,12:73,13:70,14:67,15:64,16:61,17:58,18:56,19:54,20:52,21:50,22:48};
  function chromMetrics(label){ if(label==='X') return {h:85,arm:1.1,bands:4}; if(label==='Y') return {h:60,arm:0.9,bands:3}; const n=Number(label); return {h:lengthMap[n]||90, arm:1+(n%3)*0.15, bands:3+(n%3)}; }
  function makeChromosomeEl(label, ghost){
    const m = chromMetrics(label); const w=32; const r=10; const pArm = m.h/(1+m.arm); const bands = Array.from({length:m.bands},(_,i)=>i);
    const wrap = document.createElement('div'); wrap.className = 'chrom'+(ghost?' ghost':''); wrap.style.display='flex'; wrap.style.flexDirection='column'; wrap.style.alignItems='center';
    const svgNS='http://www.w3.org/2000/svg'; const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width',w); svg.setAttribute('height',m.h); svg.setAttribute('viewBox','0 0 '+w+' '+m.h); svg.setAttribute('aria-hidden','true');
    const rect=document.createElementNS(svgNS,'rect'); rect.setAttribute('x','2'); rect.setAttribute('y','0'); rect.setAttribute('rx',r); rect.setAttribute('ry',r); rect.setAttribute('width',w-4); rect.setAttribute('height',m.h); rect.setAttribute('fill', ghost? '#eef2ff':'#e5e7eb'); svg.appendChild(rect);
    const centro=document.createElementNS(svgNS,'rect'); centro.setAttribute('x','2'); centro.setAttribute('y',pArm-6); centro.setAttribute('width',w-4); centro.setAttribute('height',12); centro.setAttribute('rx',8); centro.setAttribute('fill','#ffffff'); centro.setAttribute('fill-opacity','0.6'); svg.appendChild(centro);
    bands.forEach((b)=>{ const t=document.createElementNS(svgNS,'rect'); t.setAttribute('x','4'); t.setAttribute('y', 4+b*6.5); t.setAttribute('width',w-8); t.setAttribute('height',3); t.setAttribute('fill','#ffffff'); t.setAttribute('fill-opacity','0.35'); svg.appendChild(t); });
    bands.forEach((b)=>{ const t=document.createElementNS(svgNS,'rect'); t.setAttribute('x','4'); t.setAttribute('y', pArm+8+b*6.5); t.setAttribute('width',w-8); t.setAttribute('height',3); t.setAttribute('fill','#ffffff'); t.setAttribute('fill-opacity','0.35'); svg.appendChild(t); });
    const cap=document.createElement('small'); cap.textContent=label; cap.style.marginTop='4px'; cap.style.fontSize='12px'; cap.style.fontWeight='700'; cap.style.color=ghost? '#cbd5e1':'#334155';
    wrap.appendChild(svg); wrap.appendChild(cap); return wrap;
  }

  // --- Tray & interactions -------------------------------------------------
  const tray = document.getElementById('tray');
  const btnHint = document.getElementById('btn-hint');
  const btnReset = document.getElementById('btn-reset');

  btnHint.addEventListener('click', ()=>{ if(currentChrom){ hintFor=currentChrom; updateSlotStates(); }});
  btnReset.addEventListener('click', init);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && isPicking){ isPicking=false; updateTraySelected(false); }});

  function updateTray(){
    tray.innerHTML = '';
    if(!currentChrom){ const msg=document.createElement('span'); msg.className='muted'; msg.textContent='No chromosome presented.'; tray.appendChild(msg); return; }
    const card=document.createElement('button'); card.type='button'; card.className='chrom-card'; card.draggable=true; card.setAttribute('aria-selected', String(isPicking));
    card.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', currentChrom); e.dataTransfer.effectAllowed='move'; });
    card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); isPicking=true; updateTraySelected(true);} });
    card.addEventListener('click', ()=>{ isPicking=true; updateTraySelected(true); });
    card.appendChild(makeChromosomeEl(currentChrom,false));
    const lab=document.createElement('span'); lab.className='chrom-label'; lab.textContent=currentChrom; card.appendChild(lab);
    tray.appendChild(card);
  }
  function updateTraySelected(sel){ const btn=tray.querySelector('.chrom-card'); if(btn) btn.setAttribute('aria-selected', sel? 'true':'false'); }

  // --- Slot events ---------------------------------------------------------
  function bindSlotEvents(slotEl, expectedLabel){
    slotEl.setAttribute('role','button'); slotEl.setAttribute('tabindex','0'); slotEl.setAttribute('aria-label',`Slot for chromosome ${expectedLabel} (empty)`);
    slotEl.addEventListener('dragover', (e)=>{ if(currentChrom===expectedLabel && !placed[expectedLabel]){ e.preventDefault(); slotEl.classList.add('accept'); } });
    slotEl.addEventListener('dragleave', ()=> slotEl.classList.remove('accept'));
    slotEl.addEventListener('drop', (e)=>{ e.preventDefault(); slotEl.classList.remove('accept'); handleDropAttempt(expectedLabel, slotEl); });
    slotEl.addEventListener('click', ()=>{ if(isPicking) handleDropAttempt(expectedLabel, slotEl); });
    slotEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); if(isPicking) handleDropAttempt(expectedLabel, slotEl); }});
  }

  function handleDropAttempt(expectedLabel, slotEl){
    attempts++;
    if(isCorrectDrop(expectedLabel, currentChrom) && !placed[expectedLabel]){
      placed[expectedLabel] = true; score++;
      slotEl.classList.add('filled','just-placed');
      setTimeout(()=>slotEl.classList.remove('just-placed'), 900);
      slotEl.innerHTML=''; slotEl.appendChild(sideCap(expectedLabel)); slotEl.appendChild(makeChromosomeEl(expectedLabel,false));
      setFeedback(true, expectedLabel); celebrate(); isPicking=false; updateTraySelected(false);
      currentChrom=null; setTimeout(spawnNext, 120);
    } else {
      setFeedback(false, expectedLabel);
    }
    updateStats(); updateSlotStates(); checkCompletion();
  }

  // --- Feedback & stats ----------------------------------------------------
  const feedback = document.getElementById('feedback');
  function setFeedback(ok, label){
    feedback.innerHTML=''; if(ok==null) return;
    const pill=document.createElement('span'); pill.style.display='inline-block'; pill.style.padding='6px 10px'; pill.style.borderRadius='12px'; pill.style.border='1px solid'; pill.style.fontSize='14px';
    if(ok){ pill.style.background='#ecfdf5'; pill.style.borderColor='#bbf7d0'; pill.style.color='#065f46'; pill.textContent = `Correct! Placed chromosome ${label}.`; }
    else{ pill.style.background='#fff1f2'; pill.style.borderColor='#fecdd3'; pill.style.color='#9f1239'; pill.textContent = `Not quite. Try placing chromosome ${currentChrom}.`; }
    feedback.appendChild(pill);
  }

  const statScore = document.getElementById('score');
  const statAttempts = document.getElementById('attempts');
  const statAccuracy = document.getElementById('accuracy');
  function updateStats(){
    const prev = lastScore; statScore.textContent = String(score); statAttempts.textContent = String(attempts); statAccuracy.textContent = getAccuracy(score,attempts)+"%";
    if(score>prev){ statScore.classList.remove('pop'); void statScore.offsetWidth; statScore.classList.add('pop'); }
    lastScore = score;
  }

  // --- Completion overlay --------------------------------------------------
  const overlay = document.getElementById('overlay');
  const donePlaced = document.getElementById('done-placed');
  const doneAttempts = document.getElementById('done-attempts');
  const doneAccuracy = document.getElementById('done-accuracy');
  document.getElementById('btn-again').addEventListener('click', ()=>{ setOverlay(false); init(); });
  function setOverlay(show){ overlay.setAttribute('aria-hidden', show? 'false':'true'); }
  function checkCompletion(){
    const remaining = Object.keys(placed).filter(k=>!placed[k]);
    if(remaining.length===0){ donePlaced.textContent=String(score); doneAttempts.textContent=String(attempts); doneAccuracy.textContent=getAccuracy(score,attempts)+"%"; setOverlay(true); }
  }

  // --- Present / Spawn -----------------------------------------------------
  function spawnNext(){
    const remaining = Object.keys(placed).filter(k=>!placed[k]);
    if(remaining.length===0){ currentChrom=null; updateTray(); return; }
    const pick = remaining[Math.floor(Math.random()*remaining.length)];
    currentChrom = pick; hintFor = null; updateTray(); updateSlotStates();
  }

  function updateSlotStates(){
    Object.keys(placed).forEach(label=>{
      const slot=document.getElementById('slot-'+label); if(!slot) return;
      const canAccept = currentChrom===label && !placed[label];
      slot.classList.toggle('accept', canAccept);
      slot.classList.toggle('hint', hintFor===label && !placed[label]);
    });
  }

  // --- Init ---------------------------------------------------------------
  function init(){
    placed = {}; attempts = 0; score = 0; lastScore = 0; isPicking=false; hintFor=null; setFeedback(null);
    buildGrid();
    // Mark targets: one per autosome + the missing sex chromosome
    AUTOSOMES.forEach(n=> placed[n] = false);
    // Determine which sex label is target by checking which slot got an id
    const sexTarget = document.getElementById('slot-X')? 'X' : 'Y';
    placed[sexTarget] = false;
    updateStats(); spawnNext();
    requestAnimationFrame(fitToScreen);
  }

  init();

  // --- Celebration confetti ----------------------------------------------
  function celebrate(){
    const colors=["#f97316","#22c55e","#06b6d4","#a78bfa","#ef4444","#eab308"]; const pieces=28;
    for(let i=0;i<pieces;i++){
      const c=document.createElement('div'); c.className='confetti'; c.style.left=(Math.random()*100)+'vw';
      const sz = 6 + Math.random()*8; c.style.width = sz+'px'; c.style.height=(sz+4)+'px'; c.style.background=colors[Math.floor(Math.random()*colors.length)];
      document.body.appendChild(c); setTimeout(()=>c.remove(), 1200);
    }
  }
})();
</script>
</body>
</html>
